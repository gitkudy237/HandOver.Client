@page "/additem"

@inject UsersClient UsersClient
@inject ItemsConditionsClient ItemsConditionsClient
@inject CategoriesClient CategoriesClient
@inject ItemsClient ItemsClient
@inject NavigationManager NavigationManager

<PageTitle>New Item</PageTitle>

<div class="main-content">
    <h2>New Item</h2>
    @if (_categories is null ||
    _users is null ||
    _conditions is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <EditForm class="form" Model="@_item" FormName="addItem" OnSubmit="HandleSubmit">
            <h3>Add New item</h3>
            <div>
                <label for="name">Item name:</label>
                <InputText class="input" type="text" id="name" placeholder="Enter item name..." @bind-Value="_item.Name" />
            </div>
            @* This is momentary *@
            <div>
                <label for="image">Image url:</label>
                <InputText class="input" type="text" id="image" placeholder="Enter Image url..."
                    @bind-Value="_item.ImageUrl" />
            </div>
            <div>
                <label for="location">Location:</label>
                <InputText class="input" type="text" id="location" placeholder="Enter location..."
                    @bind-Value="_item.Location" />
            </div>
            <div>
                <label for="category">Item Condition:</label>
                <InputSelect type="text" id="category" @bind-Value="_item.CategoryId">
                    <option value="">Select category</option>
                    @foreach (var category in _categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </InputSelect>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="">Item condition:</label>
                <div class="radio-container">
                    <InputRadioGroup @bind-Value=_item.ConditionId>
                        @foreach (var condition in _conditions)
                        {
                            <InputRadio Value="@condition.Id" id="@condition.Id" />
                            <label for="@condition.Id">@condition.Condition</label>
                        }
                    </InputRadioGroup>
                </div>
            </div>
            <div>
                <label for="price">Price:</label>
                <InputNumber class="input" id="price" placeholder="Enter item price..." @bind-Value="_item.Price" />
            </div>

            <input class="btn btn--block btn--primary" type="submit" value="Add Item" />
        </EditForm>
    }
</div>



@code {
    [SupplyParameterFromForm]
    private ItemDetails _item { get; set; } = new()
        {
            Name = string.Empty,
            Location = string.Empty,
            PostedOn = DateTime.UtcNow
        };

    private List<User>? _users;
    private Category[]? _categories;
    private ItemCondition[]? _conditions;
    private User? _seller;

    protected override void OnInitialized()
    {
        _users = UsersClient.GetUsers();
        _categories = CategoriesClient.GetCategories();
        _conditions = ItemsConditionsClient.GetItemsConditions();

        _seller = _users[RandomNumber(_users.Count)];
    }

    protected override void OnParametersSet()
    {
        _item.SellerId = _seller!.Id;
    }

    public int RandomNumber(int max)
    {
        Random random = new();
        return random.Next(max);
    }

    public void HandleSubmit()
    {
        ItemsClient.AddItem(_item);
        NavigationManager.NavigateTo("/");
    }
}
